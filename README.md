# MiniWebProject
[테스트 서버](http://59.28.90.58:3000/info)
개인 컴퓨터에 포트포워딩 해놨습니다.

# 개요
학원 수업 중 배운것들 정리 겸 개인적으로 공부한 것들 적용을 위한 개인 프로젝트입니다.  
목적은 기본적인 게시판 기능 클론, 그 외 기능 구현 및 기술 스택 연습에 목적을 둡니다.  
학원 수업을 들으면서 따로 하는거라 하루에 많은 시간을 투자할 수 없습니다.  
만약 잘 만들어 진다면 취업용 이력서에 포함할 예정입니다.  

[1. 기술 스택](#%EA%B8%B0%EC%88%A0-%EC%8A%A4%ED%83%9D)  
[2. 업데이트 내역](#업데이트-내역)  
[3. 구현된 기능](#구현된-기능)  
[4. 구현할 기능](#구현할-기능)  
[5. 라이선스](#라이선스)  
[6. todo](#todo)  
[7. 고민](#고민)  
[8. 작업 히스토리](#작업-히스토리)  

# 기술 스택
Front-end: react, typeScript  
Back-end: Spring Boot 2.7.6  
인증/인가: JWT Token, Spring Security  
컨테이너화: Docker                                  
배포: AWS ec2, GitHub Actions을 이용한 ci/cd 자동배포    
데이터베이스: aws mySql                          
ORM : jpa  
외부 라이브러리 : Ck Editor, Material UI  
파일 저장 : db -> aws S3    

# 업데이트 내역
0.0.2.4
채팅 기능 구현

0.0.2.3
파일 업로드 구현

0.0.2.2  
댓글 알림 구현  

0.0.2
기본적인 게시판 기능(crud, 댓글) 구현 완료

0.0.1.3
게시판 crud 구현 완료.

0.0.1.2
게시글 쓰기, 게시글 조회 구현.  

0.0.1.0
시큐리티 설정 완료.  
로그인/회원가입 구현 완료.  

# 구현된 기능
Spring Security를 사용한 jwt 토큰 인증/인가  
게시판 crud  
인증된 사용자만 게시글 쓰기 가능   
본인이 쓴 게시글만 수정/삭제 가능  
댓글 및 대댓글   
sse를 이용한 댓글 알림  
첨부파일 다운로드  
단건 파일 업로드, 다운로드  
사진 업로드 시 썸네일 만들어 저장  
여러건 파일 업로드, 다운로드
웹소켓 채팅 기능

# 구현할 기능
## 공통 기능
도커 연습을 위한 백/프론트 컨테이너로 각각 구동하여 도커 네트워크로 통신  
aws에 github를 통해 자동 배포  

## 비회원 기능  

## 게시글 기능
여러건 파일 업로드, 다운로드  
파일 s3에 업로드  
작성자, 제목, 내용 검색 기능  
공지사항 기능  

## 유저 기능
유저 정보 수정  
회원 탈퇴  
관리자에게 채팅 문의  

## 관리자 기능
관리자 페이지 - 삭제한 게시물 보기, 유저 권한(권한, 탈퇴 등) 설정, 채팅 문의 확인
채팅 요청한 회원과 채팅  

# 라이선스
CKEditor 5: GPL-2, Commercial License (https://github.com/ckeditor/ckeditor5)  

# todo - 우선순위순으로
테스트 코드 작성 - 중간중간 틈나는 대로 틈틈이 
aws에 자동 배포 구현  
redis 연동 - sse 연결 정보등을 저장  
유저 페이지 구현 - 비밀번호 변경, 회원탈퇴  
관리자 페이지 구현 - 유저 권한 변경  
검색 기능 구현 - 게시글 내용, 작성자, 제목으로 검색  
s3에 파일 업로드  
관리자에게 채팅 문의하기 구현 - 유저가 요청하면 관리자에게 알림, 관리자가 리스트에서 선택하면 채팅 연결 후 채팅  
공지사항 구현 - 공지사항으로 설정된 게시글 첫번째 페이지 최상단에 게시  
관리자 게시글 관리 기능 구현 - 게시글 및 댓글 삭제, 관리자 페이지에서 삭제한 게시물 보기  
유저 페이지에 최근 작성한 게시글, 댓글 확인  


# 고민
게시글 수정에서 업로드한 파일도 수정 할 때에 서버에 올라간 파일의 중복 처리  
결론 - 해당 게시글의 파일을 모두 삭제한뒤 새로 업로드 한다. 로 결정   

게시글 수정에서 동시성 문제(수정중 조회수 같은것들) 고민을 해보자.  
- 우선은 트랜잭션으로 해결

댓글 알림을 받기 위해 sse연결을 할 때에 sse의 EventSource로는 header에 토큰 정보를 담아 보낼수 없었다.  
이걸 해결하기 위한 방법으로 EventSource를 재정의 하거나 url에 정보를 포함하는 방식 중 하나를 선택해야 했다.  
이번에는 간단하게 url에 토큰에서 받아온 username을 전송하기로 했다.  
그 이유는 sse로 연결하는 이유가 댓글 알림을 받기 위해서인데 설령 클라이언트의 토큰이 위조되어 다른 아이디의 댓글 알림을 받는다고 해도 보안상 큰 문제가 발생하지 않을것이라 판단했다.  
차후 관리자가 받을 알림 서비스에서는 메서드를 재정의 하기로 했다.  

# 작업 히스토리
23.11.03
우선순위를 살짝 수정해서, redis 연동을 연습해 보았다.
레디스는 도커 컨테이너로 실행시켜서 연동하였다.
또한 자동배포를 위한 사전작업으로 중요한 자료나 url같은것을 환경변수로 전환하는 작업을 하고있다.

23.11.02
어제 채팅기능을 완성하려 했으나, 집에 가니 너무 피곤해서 저녁먹고 바로 자버렸다.
메세지를 받아오는데까지만 구현해둔 채팅 기능을 최적화 하면서 디자인을 적용 하였다.
사용자 아이디 추가, 비회원일 경우 랜덤 문자열을 생성하여 아이디 대신 사용,
메시지를 보낸 사용자가 클라이언트에 로그인 된 사용자와 동일한 경우 다른 디자인 적용,
메시지 저장 배열 최대 크기 지정 등을 적용하였다.

로그아웃시 본인이 작성한 채팅이 다른사람의 채팅으로 간주되어 디자인이 바뀌는 현상이 생겼다.
해결방안
1. 로그아웃시 채팅 나가기(비회원 채팅 금지)
2. 로그아웃시 이전 로그인 기록을 저장하여 처리
3. 사용자 관계 없이 일정한 디자인으로 적용

우선은 2번으로 진행하기로 했다. 로그인 기록용으로 저장하는것은 username인데, 해당 정보는 게시판에 글을쓸때에도 노출되는 정보이니 로컬스토리지에 저장해 둔다하여 큰 문제가 생기지 않을거라는 판단이다. 설령 조작이 된다 하더라도 지금 당장은 해당 정보를 사용하는 용도가 디자인 적용뿐인지라 괜찮을것 같다.

스프링 테스트를 처음 써보았다.
우선은 서비스쪽의 메서드를 실행하고 테스트 하는 작업만 해 보았다. 테스트의 경우에는 예외 처리라든지, 상황에 대한 결과를 예상하고 처리해야 해서 적응 하는데 꽤 많은 시간이 걸릴 것 같다.


---
23.11.01  
웹소켓 채팅 기능 구현중  
웹소켓 연결을 구현하였다.  
메세지가 온다면, 배열에 추가하는 로직이 잘 안되었다.  
useState로 바인딩 되어 있는 배열에 setter로 설정하면 최신 메세지만 남았다.  
웹소켓 구독 함수가 비동기적으로 움직여서 그랬다.  
setter 함수에서 어레이펑션으로 설정 해 주니 잘 되었다.  
setMessages(prevMessages => [...prevMessages, newMessage]);  

---
23.10.31  
sse연결 외부 연결의 문제점을 해결했다.  
처음 eventSource = new EventSource(`http://127.0.0.1:8080/api/notification?username=${username}`); 했을 때는 로컬에서만 동작하고 외부 접속에서는 연결이 아예 안되었다.  
당시 외부 연결을 ngrok으로 했었는데, 프론트 포트로 ngrok 주소를 받았었다.  
그리고 EventSource(ngrok주소/apk...)으로 했을때는 onopen 이벤트는 발생하는데 정작 메세지는 전달되지 않았다.  
스프링부트 설정을 잘못했나 싶어서 로깅을 살펴보니, 스프링부트에서는 에러 없이 메세지가 발송됐다고 나왔다.  
프론트에서도 onmessage나 onerror가 반응하지 않았고 이벤트리스너로도 아무 반응이 없었다.  
devtools로 네트워크 탭을 보니 connection 이 close로 반환되고 있었다.  
백단에서 명시적으로 connection을 keep-alive로 선언해 주었더니 keep-alive,close 로 반환이 되었다.  
스택오버플로우에 찾아보니 크롬에서는 저런 형태일 때 keep-alive로 간주한다고 하는데도 메세지는 전달되지 않았다.  

해결 - 알고보니 매우 간단한 문제였다. ngrok을 백 포트로도 열고 eventsource 주소를 백 포트로 잡아주어야 했던것이었다.  
sSE는 HTTP 연결을 유지하기 때문에, 프론트엔드와 백엔드가 모두 해당 포트로 열려 있어야 했던 것이다.  

파일 업로드를 구현했다.  
사진을 ckeditor로 업로드 하게 되면 file 테이블에 이미지임을 나타내며 저장한다.  
이후 url을 리턴하여 html내에서 이미지를 볼 수 있도록 하였다.  
파일 업로드도 비슷한 방식으로 하되 isImage를 flase로 저장하였다.  
그리고 게시글 정보를 불러 올 때 첨부 파일을 list에 첨부하여 같이 불러오도록 하였다.  
저장은 예제도 많고 해서 괜찮았지만, 문제는 이미지 파일이 게시글 작성중에 db에 업로드 된다는게 문제였다.  
파일을 업로드 할 때에는 게시글과 같이 데이터를 보내어 게시글을 db에 삽입 한 후 bid를 받아와 설정 하는게 가능했는데,  
이미지는 게시글을 작성할 때에 업로드 되기 때문에 bid를 집어 넣기힘들었다.  
또한 게시글 작성 중 삭제되는 이미지파일에 대해선 이벤트를 작성하기가 힘들었다.  

해결 - 게시글을 저장 할 때에 게시글 내용에서 정규식을 이용해 url에 첨가되어 있는 이미지 파일의 pk값을 가져오도록 했다.  
해당 pk값으로 파일 테이블에 있는 이미지 파일의 bid를 설정 한 후, 같은 작성자의 bid가 초기값인 자료를 삭제 하도록 했다.  

---
23.10.30  
학원에서 개인 블로그 만들기 과제가 나왔다.  
개인 과제이지만 팀원과의 소통이 필요하기에 해당 과제를 우선하기로 했다.  

ngrok으로 학원에서 실행시켜 봤더니, sse 메세지가 안받아 와 졌다.  
sse연결은 주소를 바꿨더니(localhost -> ngrok 접속 주소로) 연결 요청과 연결이 완료 됬다고는 뜨는데  
실제로는 안된건지, 아니면 message가 안보내진건지, 보냈는데 네트워크 설정에 의해 차단된건지 모르겠다.

onopen 이벤트가 발생한걸 보니 연결은 된것으로 보인다.  
백엔드 로깅에선 메세지가 잘 보내진것으로 나온다.  
하지만 실질적으로 메세지가 받아와 지지는 않는다.

---
23.10.29  
이전 연습때 했던 기록이 필요할 것 같아 기억을 더듬어 연습때 했던 생각을 블로그에 정리해 보았다.  
[블로그](https://jy-java.tistory.com/category/%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/%EA%B0%9C%EC%9D%B8%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8)  
앞으로 readme에는 간략하게 적고 블로그에 상세 내용을 적어보자.  
오후에 약속이 있어서 오늘은 여기까지만...  

---

23.10.28  
댓글 crud 완성  
대댓글 완성  
댓글 알림 완성 - 기능 구현만 해서 디자인이라든지 좀 다듬을 필요 있음 근데 중요한건 아니니까 일단 미룸  

여기까진 연습 프로젝트에서 했던것들을 참고하면서 해서 오래걸리진 않았다.  
특히 프론트 쪽은 거의 복붙이었다.  

댓글 카운팅의 동작이 이상했었는데, 학원에서 update, delete할 때에는 transaction을 해주어야 한다고 해서 적용했더니 이상동작이 사라졌다. 아직 좀 더 테스트 해봐야겠지만 지금은 이대로도 괜찮을듯.  

또한 현재 sse 정보 저장을 map에 하고 있는데, 이것은 redis 같은 키값 db를 사용해도 될 것 같은데 한번 생각해볼만한 문제인것 같다.  

---
23.10.27  
게시판 crud완성  

---
23.10.26  
프로젝트 생성.  
이전 연습에서 썻던 코드를 가져와서 수정함  
이전 연습에 대한 기록은 [여기](https://jy-java.tistory.com/category/%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8/%EA%B0%9C%EC%9D%B8%20%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8)  
스프링 시큐리티 적용.  
jwt filter, service 적용.  
로그인/ 회원가입 기능 완료.  

# 작업 중 발생한 에러  
ERROR 24656 --- [nio-8080-exec-3] o.h.engine.jdbc.spi.SqlExceptionHelper   : Statement.executeQuery() cannot issue statements that do not produce result sets.  
발생 상황 - 쿼리 어노테이션을 select문 이외에(쿼리의 결과가 집합으로 표현될 수 없을때) 사용했을 때.  
예시 - update문, delete문 등  
해결 방법 - 쿼리 어노테이션 위에 @Modifying, @Transactional을 추가해주면 해결된다.  
이유 - 기본적으로 하이버네이트는 데이터를 반환 하려 하는데, update 같은 경우에는 반환되는 데이터가 없음. 결과만 반환됨.  
    따라서 @Modifying을 사용하여 반환되는 데이터가 없음을 알려준다.  
    @Transactional을 추가하는 이유는 작업을 하나의 트랜잭션으로 만들어 데이터의 일관성을 보장하기 위해서.  