# MiniWebProject
[테스트 서버](http://54.180.87.66)
개인 컴퓨터에 포트포워딩 해놨습니다.

# 개요
학원 수업 중 배운것들 정리 겸 개인적으로 공부한 것들 적용을 위한 개인 프로젝트입니다.  
목적은 기본적인 게시판 기능 클론, 그 외 기능 구현 및 기술 스택 연습에 목적을 둡니다.  
학원 수업을 들으면서 따로 하는거라 하루에 많은 시간을 투자할 수 없습니다.  
만약 잘 만들어 진다면 취업용 이력서에 포함할 예정입니다.  

[1. 기술 스택](#%EA%B8%B0%EC%88%A0-%EC%8A%A4%ED%83%9D)  
[2. 업데이트 내역](#업데이트-내역)  
[3. 구현된 기능](#구현된-기능)  
[4. 구현할 기능](#구현할-기능)  
[5. 라이선스](#라이선스)  
[6. todo](#todo)  
[7. 고민](#고민)  
[8. 작업 히스토리](#작업-히스토리)  
[9. 환경변수](#환경변수)  

# 기술 스택
Front-end: react, typeScript  
Back-end: Spring Boot 2.7.6  
인증/인가: JWT Token, Spring Security  
컨테이너화: Docker                                  
배포: AWS ec2, GitHub Actions을 이용한 ci/cd 자동배포    
데이터베이스: aws mySql                          
ORM : jpa  
외부 라이브러리 : Ck Editor, Material UI  
파일 저장 : db -> aws S3    

# 업데이트 내역
0.0.2.4
채팅 기능 구현

0.0.2.3
파일 업로드 구현

0.0.2.2  
댓글 알림 구현  

0.0.2
기본적인 게시판 기능(crud, 댓글) 구현 완료

0.0.1.3
게시판 crud 구현 완료.

0.0.1.2
게시글 쓰기, 게시글 조회 구현.  

0.0.1.0
시큐리티 설정 완료.  
로그인/회원가입 구현 완료.  

# 구현된 기능
Spring Security를 사용한 jwt 토큰 인증/인가  
게시판 crud  
인증된 사용자만 게시글 쓰기 가능   
본인이 쓴 게시글만 수정/삭제 가능  
댓글 및 대댓글   
sse를 이용한 댓글 알림  
웻소켓 채팅  
첨부파일 다운로드  
단건 파일 업로드, 다운로드  
웹소켓 채팅 기능   
관리자 기능 - 삭제한 게시글 보기 및 복원  
유저 정보 - 최근 작성 게시글,댓글 보기  
게시판 검색 기능  
redis 연동 - sse 연결 정보등 임시적인 데이터 저장용으로 활용   
검색 기능 구현 - 게시글 내용, 작성자, 제목으로 검색  
aws에 자동 배포 구현  

# todo
테스트 코드 작성 - 배포 하기 전 유닛 테스트 및 통합 테스트 작성하기 - 진행중     
공지사항 구현 - 공지사항으로 설정된 게시글 첫번째 페이지 최상단에 게시  
유저 페이지 구현 - 비밀번호 변경, 회원탈퇴  
관리자 페이지 구현 - 유저 권한 변경  


# 고민
현재 게시글을 쓸 때 이미지 삽입시에 db에 저장해두고 링크를 반환하는데, 게시글 작성 도중 삭제된 이미지의 처리에 대해 고민중이다.  


# 작업 히스토리
23.11.15
자동배포 완료
원하던대로 환경변수에 ec2 url, db 정보 등을 담아 자동배포에 성공하였다.

---
23.11.14
자동배포 연습

환경변수 설정 에러
환경 변수를 적용하는 과정에 있어 잘못 이해한 부분이 있어 에러가 났다.  
나는 깃허브 환경변수칸에 환경변수를 설정해두면 깃허브에서 빌드할 때에 해당 변수값이 자동으로 적용이 되서 빌드 된다고 생각했는데, 실제로는 환경변수는 빌드된 파일이 배포 될 때 배포 당시 환경변수값을 가져오는 것이어서 오류가 났다.  
또한, 깃허브에 설정해둔 값이 자동으로 들어가는게 아니라, yml에서 해당 값을 사용함을 명시적으로 선언해 주어야 했다.  
자동 배포 스크립트에서 깃허브 내에서 빌드 후에 ec2 서버로 빌드된 파일을 넘기기로 한 이유가 위의 상황 때문이었는데, 이러면 무슨 의미가 있나 싶어 배포방식을 바꿀려다가 일단 만들어둔게 있으니 그대로 진행했다. 다음 프로젝트에서 만약 자동배포를 하게 된다면, 서버에서 깃허브 레파지토리를 땡겨와서 서버에서 빌드하는 형식으로 해야겠다.  

---
23.11.13
자동배포 연습  

에러
스프링부트 테스트 - 테스트 어노테이션만 달아놓은 더미 데이터 때문에 빌드 실패  
해결 : 더미 데이터를 삭제 or 테스트 성공 리턴 작성  

리액트 빌드 에러  
Treating warnings as errors because process.env.CI = true.  
Most CI servers set it automatically.  
해결 : 해당 문제는 리액트 빌드시에, warn으로 나오는 부분들이 있을때 빌드가 실패하는 오류이다.  
CI를 false로 해두면 warn이 나와도 빌드가 된다.  
CI를 true로 두고 싶으면, 해당 warn을 해결해야 한다.

---
23.11.09  
검색 기능 완료  
디자인 적용중  
채팅 기록(신규 참여 유저에게 보여줄 내용) 레디스에 저장 - 채팅 내역 전체를 db에 저장할지는 모르겠다. 

---
23.11.08  
디자인 적용중  
게시판 조회 디자인 변경  

---
23.11.07  
학원 과제 진행  

---
23.11.06  
강사님에게 프로젝트 진행 중 피드백을 받았다.  
1. 디자인을 신경써라.  
2. 여러 종류의 게시판을 만들어 보라.  

학원 과제 진행  

---
23.11.05  
일요일이라 쉬었다.  

---
23.11.04  
관리자 - 삭제한 게시글 보기, 삭제한 게시글 복원  
유저 정보 - 작성한 글, 댓글 보기  

---
23.11.03  
redis 연동을 연습, 데이터 저장, 불러오기에 성공했다.  
레디스는 도커 컨테이너로 실행시켜서 연동하였다.  
또한 자동배포를 위한 사전작업으로 중요한 자료나 url같은것을 환경변수로 전환하는 작업을 하고있다.  

메인 페이지에 기능 테스트를 위한 단추 추가 - 권한별 로그인, sse메세지 보내기  
관리자 로그인 시 모든 게시글 삭제 기능 추가  
sse연결 최적화 - 사이트에서 나갈때(app.tsx가 언마운트 될 때) 연결 끊기, 로그아웃시 연결 끊기  

---
23.11.02  
어제 채팅기능을 완성하려 했으나, 집에 가니 너무 피곤해서 저녁먹고 바로 자버렸다.  
메세지를 받아오는데까지만 구현해둔 채팅 기능을 최적화 하면서 디자인을 적용 하였다.  
사용자 아이디 추가, 비회원일 경우 랜덤 문자열을 생성하여 아이디 대신 사용,  
메시지를 보낸 사용자가 클라이언트에 로그인 된 사용자와 동일한 경우 다른 디자인 적용,  
메시지 저장 배열 최대 크기 지정 등을 적용하였다.  

로그아웃시 본인이 작성한 채팅이 다른사람의 채팅으로 간주되어 디자인이 바뀌는 현상이 생겼다.  
해결방안  
1. 로그아웃시 채팅 나가기(비회원 채팅 금지)   
2. 로그아웃시 이전 로그인 기록을 저장하여 처리  
3. 사용자 관계 없이 일정한 디자인으로 적용  

우선은 2번으로 진행하기로 했다. 로그인 기록용으로 저장하는것은 username인데, 해당 정보는 게시판에 글을쓸때에도 노출되는 정보이니 로컬스토리지에 저장해 둔다하여 큰 문제가 생기지 않을거라는 판단이다. 설령 조작이 된다 하더라도 지금 당장은 해당 정보를 사용하는 용도가 디자인 적용뿐인지라 괜찮을것 같다.  

스프링 테스트를 처음 써보았다.  
우선은 서비스쪽의 메서드를 실행하고 테스트 하는 작업만 해 보았다. 테스트의 경우에는 예외 처리라든지, 상황에 대한 결과를 예상하고 처리해야 해서 적응 하는데 꽤 많은 시간이 걸릴 것 같다.  


---
23.11.01  
웹소켓 채팅 기능 구현중  
웹소켓 연결을 구현하였다.  
메세지가 온다면, 배열에 추가하는 로직이 잘 안되었다.  
useState로 바인딩 되어 있는 배열에 setter로 설정하면 최신 메세지만 남았다.  
웹소켓 구독 함수가 비동기적으로 움직여서 그랬다.  
setter 함수에서 어레이펑션으로 설정 해 주니 잘 되었다.  
setMessages(prevMessages => [...prevMessages, newMessage]);  

---
23.10.31  
sse연결 외부 연결의 문제점을 해결했다.  
처음 eventSource = new EventSource(`http://127.0.0.1:8080/api/notification?username=${username}`); 했을 때는 로컬에서만 동작하고 외부 접속에서는 연결이 아예 안되었다.  
당시 외부 연결을 ngrok으로 했었는데, 프론트 포트로 ngrok 주소를 받았었다.  
그리고 EventSource(ngrok주소/apk...)으로 했을때는 onopen 이벤트는 발생하는데 정작 메세지는 전달되지 않았다.  
스프링부트 설정을 잘못했나 싶어서 로깅을 살펴보니, 스프링부트에서는 에러 없이 메세지가 발송됐다고 나왔다.  
프론트에서도 onmessage나 onerror가 반응하지 않았고 이벤트리스너로도 아무 반응이 없었다.  
devtools로 네트워크 탭을 보니 connection 이 close로 반환되고 있었다.  
백단에서 명시적으로 connection을 keep-alive로 선언해 주었더니 keep-alive,close 로 반환이 되었다.  
스택오버플로우에 찾아보니 크롬에서는 저런 형태일 때 keep-alive로 간주한다고 하는데도 메세지는 전달되지 않았다.  

해결 - 알고보니 매우 간단한 문제였다. ngrok을 백 포트로도 열고 eventsource 주소를 백 포트로 잡아주어야 했던것이었다.  
sSE는 HTTP 연결을 유지하기 때문에, 프론트엔드와 백엔드가 모두 해당 포트로 열려 있어야 했던 것이다.  

파일 업로드를 구현했다.  
사진을 ckeditor로 업로드 하게 되면 file 테이블에 이미지임을 나타내며 저장한다.  
이후 url을 리턴하여 html내에서 이미지를 볼 수 있도록 하였다.  
파일 업로드도 비슷한 방식으로 하되 isImage를 flase로 저장하였다.  
그리고 게시글 정보를 불러 올 때 첨부 파일을 list에 첨부하여 같이 불러오도록 하였다.  
저장은 예제도 많고 해서 괜찮았지만, 문제는 이미지 파일이 게시글 작성중에 db에 업로드 된다는게 문제였다.  
파일을 업로드 할 때에는 게시글과 같이 데이터를 보내어 게시글을 db에 삽입 한 후 bid를 받아와 설정 하는게 가능했는데,  
이미지는 게시글을 작성할 때에 업로드 되기 때문에 bid를 집어 넣기힘들었다.  
또한 게시글 작성 중 삭제되는 이미지파일에 대해선 이벤트를 작성하기가 힘들었다.  

해결 - 게시글을 저장 할 때에 게시글 내용에서 정규식을 이용해 url에 첨가되어 있는 이미지 파일의 pk값을 가져오도록 했다.  
해당 pk값으로 파일 테이블에 있는 이미지 파일의 bid를 설정 한 후, 같은 작성자의 bid가 초기값인 자료를 삭제 하도록 했다.  

---
23.10.30  
학원에서 개인 블로그 만들기 과제가 나왔다.  
개인 과제이지만 팀원과의 소통이 필요하기에 해당 과제를 우선하기로 했다.  
다만 당장 시작하는건 아닌지라 해당 과제를 진행하기 전에 이 프로젝트를 어느정도 완성해두려 한다.

ngrok으로 학원에서 실행시켜 봤더니, sse 메세지가 안받아 와 졌다.  
sse연결은 주소를 바꿨더니(localhost -> ngrok 접속 주소로) 연결 요청과 연결이 완료 됬다고는 뜨는데  
실제로는 안된건지, 아니면 message가 안보내진건지, 보냈는데 네트워크 설정에 의해 차단된건지 모르겠다.

onopen 이벤트가 발생한걸 보니 연결은 된것으로 보인다.  
백엔드 로깅에선 메세지가 잘 보내진것으로 나온다.  
하지만 실질적으로 메세지가 받아와 지지는 않는다.

---
23.10.29  
오늘은 약속이 있어서 작업을 하지 못 하였다.

---

23.10.28  
댓글 crud 완성  
대댓글 완성  
댓글 알림 완성 - 기능 구현만 해서 디자인이라든지 좀 다듬을 필요 있음 근데 중요한건 아니니까 일단 미룸  

여기까진 연습 프로젝트에서 했던것들을 참고하면서 해서 오래걸리진 않았다.  
특히 프론트 쪽은 거의 복붙이었다.  

댓글 카운팅의 동작이 이상했었는데, 학원에서 update, delete할 때에는 transaction을 해주어야 한다고 해서 적용했더니 이상동작이 사라졌다. 아직 좀 더 테스트 해봐야겠지만 지금은 이대로도 괜찮을듯.  

또한 현재 sse 정보 저장을 map에 하고 있는데, 이것은 redis 같은 키값 db를 사용해도 될 것 같은데 한번 생각해볼만한 문제인것 같다.  

---
23.10.27  
게시판 crud완성  

---
23.10.26  
프로젝트 생성.  
이전 연습에서 썻던 코드를 가져와서 수정함   
스프링 시큐리티 적용.  
jwt filter, service 적용.  
로그인/ 회원가입 기능 완료.

# 환경변수
dburl - 데이터베이스 url (localhost:3306)  
db-user - 데이터베이스 id (id)  
db-pass - 데이터베이스 password (pass)  
redis-port - 레디스 포트 (8000)  
redis-host - 레디스 주소 (127.0.0.1)  
ec2-host - 배포 주소(127.0.0.1)  
ec2-port - 웹소켓 연결 포트(8000)  
front-host - 배포 주소(127.0.0.1)  
front-port - 배포 포트(8000)  
jwt-key - jwt 시크릿 키 (문자열)

# 작업 중 발생한 에러  
ERROR 24656 --- [nio-8080-exec-3] o.h.engine.jdbc.spi.SqlExceptionHelper   : Statement.executeQuery() cannot issue statements that do not produce result sets.  
발생 상황 - 쿼리 어노테이션을 select문 이외에(쿼리의 결과가 집합으로 표현될 수 없을때) 사용했을 때.  
예시 - update문, delete문 등  
해결 방법 - 쿼리 어노테이션 위에 @Modifying, @Transactional을 추가해주면 해결된다.  
이유 - 기본적으로 하이버네이트는 데이터를 반환 하려 하는데, update 같은 경우에는 반환되는 데이터가 없음. 결과만 반환됨.  
    따라서 @Modifying을 사용하여 반환되는 데이터가 없음을 알려준다.  
    @Transactional을 추가하는 이유는 작업을 하나의 트랜잭션으로 만들어 데이터의 일관성을 보장하기 위해서.  


# 라이선스
CKEditor 5: GPL-2, Commercial License (https://github.com/ckeditor/ckeditor5)  
